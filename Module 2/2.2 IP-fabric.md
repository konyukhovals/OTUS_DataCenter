# VRF Leaking и BGP

![image](https://github.com/user-attachments/assets/dea09b19-a80e-4059-8bce-c416c024fd57)

![image](https://github.com/user-attachments/assets/36fdbf87-39c8-418e-a91b-20cc71d0bfbf)

![image](https://github.com/user-attachments/assets/b2c2f624-f684-4b9c-9916-aa10d2959a00)

![image](https://github.com/user-attachments/assets/f55dad0b-3ba3-439c-b790-f2709ffef6e4)

![image](https://github.com/user-attachments/assets/24f781f2-beee-4772-8bc0-ec9857797884)

## Что такое VRF leaking

VRF leaking (иногда говорят «маршрутизация между VRF», «route leaking» и т.п.) — это механизм, позволяющий «делиться» маршрутами между разными VRF (Virtual Routing and Forwarding).
В стандартном случае каждый VRF — это отдельная «виртуальная» (логическая) таблица маршрутизации, изолированная от других VRF. Такая изоляция нужна для:
* Разделения трафика разных клиентов (особенно в MPLS VPN);
* Разделения сетей разных сервисов в рамках одного оператора/предприятия;
* Мультиарендности (multi-tenant) в дата-центрах;
* Сегментации сети для повышения безопасности.

Но бывают случаи, когда необходимо, чтобы один VRF «видел» маршруты другого. К примеру:
* Существует общий сервисный VRF (DNS, NTP, AD, интернет-шлюз), к которому должны обращаться разные VRF.
* Нужно выборочно «пробросить» некоторые подсети между VRF (при этом остальные остаются изолированными).

Чтобы это сделать, используется механизм VRF leaking — «протекание» (leak) маршрутов из одного VRF в другой. В MPLS L3VPN (BGP/MPLS VPN) это делается через route-target import/export, а в классических конфигурациях Cisco IOS — с помощью статических маршрутов (команда ip route vrf ...), route-map, BGP/OSPF «между VRF» и т.д.

## Для чего нужен VRF leaking

* Общий сервисный VRF. Допустим, у вас есть VRF SERVICES с ресурсами, к которым должны иметь доступ другие VRF (например, клиенты).
* Выборочный доступ. Нужно, чтобы из одного VRF были доступны только определённые сети другого VRF.
* Упрощение сети. Не всегда удобно «выводить» трафик наружу или на отдельное устройство, если можно организовать обмен маршрутами внутри одного роутера/коммутатора.

### Основные способы реализации

1. Route-target (в средах MPLS L3VPN)

В больших сетях с MPLS L3VPN маршруты «изолируются» VRF-ами, а обмен маршрутами между VRF организуется через RT (route-target):
* Export — какие метки (RT) назначаются маршрутам из VRF.
* Import — какие метки (RT) VRF «подтягивает» к себе.

Пример (упрощённый):
```
ip vrf CLIENT-A
 rd 65000:100
 route-target export 65000:100
 route-target import 65000:900

ip vrf SERVICES
 rd 65000:900
 route-target export 65000:900
 route-target import 65000:100
```

Таким образом, CLIENT-A импортирует маршруты, помеченные RT 65000:900 (то есть маршруты из VRF SERVICES), а SERVICES импортирует маршруты, помеченные RT 65000:100 (то есть из CLIENT-A). Можно настроить и односторонний доступ, если нужно.

2. Статические маршруты (ip route vrf …)

В «чистом» IOS (без MPLS) часто применяют статические маршруты, позволяющие «поделиться» маршрутами между VRF. Пример (упрощённый), когда нужно, чтобы VRF BLUE видел сеть 10.10.20.0/24 из VRF RED, и наоборот:

```
! Из BLUE в RED:
ip route vrf BLUE 10.10.20.0 255.255.255.0 10.10.10.254 global

! Из RED в BLUE:
ip route vrf RED 10.10.10.0 255.255.255.0 10.10.20.254 global
```

При этом в качестве next-hop указываем либо адрес другого VRF, либо интерфейс (в более новых версиях IOS-XE можно и так, и так). Важно аккуратно настроить маршруты в обе стороны.

3. Протоколы динамической маршрутизации (BGP/OSPF/EIGRP) «между VRF»
Можно поднять BGP или другой протокол между VRF одного и того же устройства («сам с собой»). Через route-map, фильтры, ACL определять, какие сети будут «протекать» в другой VRF. Это более редкий способ, иногда используется в особых случаях.

4. Команды import/export (IOS-XE)
В некоторых реализациях (IOS-XE) есть возможность прописывать в секции ip vrf команды наподобие:

```
ip vrf BLUE
 ...
 address-family ipv4
  import ipv4 unicast route-policy MY_RM
  export ipv4 unicast route-policy MY_RM

```

Либо import ipv4 unicast from VRF RED, что позволяет «выбрать» конкретные сети из VRF RED. Но это, по сути, более современный аналог идеи с RT или со статическими маршрутами.

## VRF leaking в CLOS

В CLOS-сетях (leaf-spine архитектура), особенно в больших дата-центрах, VRF используется для мультиарендности (tenant) или сегментации внутри одного арендатора. Тогда leaking необходим, когда разные VRF должны «видеть» общий сервис (интернет, DNS, мониторинг и т.д.).
* В EVPN/VXLAN (часто в современных DC) leaking реализуется через import/export RT (похожим образом, как в MPLS).
* В классической L3 CLOS без EVPN может быть «центральный» роутер (border / service leaf), где настроен BGP, и там делается взаимный обмен маршрутами между VRF с нужными RT или статикой.

## VRF leaking — механизм, позволяющий выборочно пробрасывать маршруты между VRF, которые изначально изолированы друг от друга.

Применяется для доступа к общим службам, интерент-шлюзу, взаимных сервисов и т.д.

Способы:
* MPLS L3VPN: через route-target import/export;
* Статические ip route vrf ...: для небольших сценариев;
* Динамические протоколы (BGP, OSPF и т.п.): когда нужно гибко управлять маршрутами;
* IOS-XE import/export: более современные команды, похожие на RT-модель.

В контексте CLOS (leaf-spine) VRF leaking актуален при необходимости предоставлять общие сервисы нескольким VRF.
Таким образом, VRF leaking — это контролируемый обмен маршрутами, позволяющий «пробросить» нужные префиксы между виртуальными таблицами маршрутизации.





