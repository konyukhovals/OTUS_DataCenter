# Table of contents

 [ECMP (на примере OSPF) И UCMP](#item-one)


 

 <!-- headings -->


<a id="item-one"></a>
## ECMP (на примере OSPF) И UCMP 

* ECMP (Equal Cost Multi-Path) в OSPF
>
>OSPF может одновременно использовать несколько маршрутов с одинаковым метриком (Cost) до одной цели.
>Это даёт балансировку нагрузки по нескольким равнозначным путям (например, 2 или 4).
>В Cisco это настраивается параметром maximum-paths внутри router ospf. Пример:
>
>
```
router ospf 1
  network 10.0.0.0 0.255.255.255 area 0
  maximum-paths 4
```

* В таблице маршрутизации при наличии 2 путей с одинаковым Cost OSPF покажет оба next-hop.

```
    R1# show ip route 10.1.1.0
    O 10.1.1.0/24 [110/20] via 192.168.1.2, 00:00:12, GigabitEthernet0/0
                        via 192.168.2.2, 00:00:12, GigabitEthernet0/1
```
Здесь два равных пути (Cost=20).


* UCMP (Unequal Cost Multi-Path)
>
>Позволяет использовать разные пути с разным Cost для балансировки. Чаще встречается в EIGRP (через variance) или в проприетарных расширениях.
>Стандартный OSPF не умеет UCMP «из коробки» – он игнорирует пути с большим Cost, выбирая только равные минимальные.
>Пример в EIGRP (не OSPF), где настроен UCMP:

```
    router eigrp 1
      network 10.0.0.0
      variance 2
      maximum-paths 4
```

Это разрешает привлекать маршруты, чей метрик не превышает минимальный в 2 раза, и балансировать трафик пропорционально.

* Итог

>ECMP в OSPF – равные пути, стандартный функционал, балансировка «1:1».
>UCMP – балансировка с разными весами (не стандарт для OSPF).

* В ospf - по какому признаку балансируется нагрузка в ECMP? 

В OSPF сама балансировка при наличии нескольких равных (Equal Cost) маршрутов заключается в том, что протокол устанавливает в таблицу маршрутизации сразу несколько next-hop с одинаковой метрикой. Как именно трафик распределяется между этими next-hop, обычно зависит не от самого OSPF, а от механизма форвардинга (CEF на Cisco, PF на Juniper и т.п.).
1. По какому признаку идёт балансировка по умолчанию?

* На большинстве платформ (Cisco, Juniper и др.) многопутевая маршрутизация (ECMP) делается по хэшированию комбинации полей пакета (обычно src IP, dst IP, иногда src/dst порт, протокол и т.д.).
* Смысл в том, чтобы один поток (flow) не «прыгал» между разными путями (не ломал TCP-сессии).
* В Cisco IOS классическое поведение – per-destination load balancing (по умолчанию в CEF). То есть исходя из IP-адресов (и, в зависимости от платформы, от других полей) вычисляется хэш, и весь трафик данного потока идёт одним next-hop.

2. Можно ли менять признаки (перенастроить хэш)?

* Да, но это зависит от платформы/OS, а не от OSPF.
* На Cisco IOS можно переключить на per-packet load balancing (тогда каждая следующая пачка пакетов идёт по разным путям). Делается так:

```
router ospf 1
  maximum-paths 4
!
ip cef
!
interface GigabitEthernet0/0
  ip load-sharing per-packet
```
Однако «per-packet» редко используют в продакшене из-за возможных проблем с reorder пакетов.
Для «fine-tune» хэширования (например, учитывать или нет порты) на некоторых платформах Cisco (Catalyst, Nexus) или на Juniper можно изменять так называемый load-balance hashing. В Cisco:

```
(config)# mlsh ?  <- (на некоторых моделях Catalyst)
```
Или в NX-OS:
```
    port-channel load-balance <...>
```
    Для routed-трафика (ECMP) используется схожая логика, где иногда можно добавить/убрать учет L4 портов или MAC и т. д.

3. Итог

* OSPF просто ставит несколько равных маршрутов (ECMP) в RIB, а дальше механизм форвардинга (CEF/другая технология) делает балансировку.
* По умолчанию это «per-destination» (хэш на базе IP + другие поля).
* Да, можно настроить «per-packet» или другой вариант хэширования (включить/выключить учёт портов) – но это настройки дата-плана (CEF, порт-ченнелы), а не самого OSPF.



